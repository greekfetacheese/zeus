#[cfg(test)]
mod tests {
   use crate::core::{BaseFee, ZeusCtx};
   use crate::gui::ui::dapps::uniswap::swap::get_relevant_pools;
   use crate::utils::{
      swap_quoter::{get_quote, get_quote_with_split_routing},
      zeus_delegate::encode_swap_delegate,
   };
   use std::str::FromStr;

   use zeus_eth::{
      abi::zeus as zeus_abi,
      alloy_primitives::{Address, Bytes, TxKind, U256},
      alloy_provider::Provider,
      alloy_rpc_types::BlockId,
      alloy_signer::SignerSync,
      amm::uniswap::{AnyUniswapPool, UniswapPool, UniswapV2Pool},
      currency::{Currency, ERC20Token, NativeCurrency},
      revm_utils::*,
      utils::{NumericValue, SecureSigner, address_book},
   };

   use alloy_eips::eip7702::Authorization;
   use alloy_sol_types::{SolCall, SolValue};
   use either::Either;

   const ZEUS_DELEGATE_CODE: &str = "0x610100604052348015610010575f5ffd5b5060405161232338038061232383398101604081905261002f9161007d565b80516001600160a01b039081166080526020820151811660a0526040820151811660c0526060909101511660e052610105565b80516001600160a01b0381168114610078575f5ffd5b919050565b5f608082840312801561008e575f5ffd5b50604051608081016001600160401b03811182821017156100bd57634e487b7160e01b5f52604160045260245ffd5b6040526100c983610062565b81526100d760208401610062565b60208201526100e860408401610062565b60408201526100f960608401610062565b60608201529392505050565b60805160a05160c05160e05161219861018b5f395f818160cc01526103be01525f81816101a2015261084001525f818161016f015281816105650152818161061b015281816106b901528181610dc2015261112101525f818161013c01528181610a0101528181611212015281816112a40152818161135901526113d801526121985ff3fe60806040526004361061007c575f3560e01c8063ad5c46481161004c578063ad5c46481461012b578063e34e72831461015e578063f73e5aab14610191578063fa461e33146101c4575f5ffd5b806301a3f1e81461008757806323a69e751461009c578063695033f3146100bb57806391dd73461461010b575f5ffd5b3661008357005b5f5ffd5b61009a610095366004611896565b6101e3565b005b3480156100a7575f5ffd5b5061009a6100b6366004611912565b610365565b3480156100c6575f5ffd5b506100ee7f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b0390911681526020015b60405180910390f35b61011e610119366004611961565b610558565b60405161010291906119ce565b348015610136575f5ffd5b506100ee7f000000000000000000000000000000000000000000000000000000000000000081565b348015610169575f5ffd5b506100ee7f000000000000000000000000000000000000000000000000000000000000000081565b34801561019c575f5ffd5b506100ee7f000000000000000000000000000000000000000000000000000000000000000081565b3480156101cf575f5ffd5b5061009a6101de366004611912565b6107e7565b5f806101f56060840160408501611a07565b6001600160a01b03160361020b57503331610227565b61022461021e6060840160408501611a07565b336109c2565b90505b6102466102348380611a22565b6102416020860186611a65565b6109f5565b5f806102586060850160408601611a07565b6001600160a01b03160361026e57503331610284565b61028161021e6060850160408601611a07565b90505b8181116102d85760405162461bcd60e51b815260206004820152601c60248201527f42616420537761703a204e6f20616d6f756e742072656365697665640000000060448201526064015b60405180910390fd5b5f6102e38383611abf565b9050836060013581101561035f5760405162461bcd60e51b815260206004820152602260248201527f536c697070616765436865636b3a20496e73756666696369656e74206f75747060448201527f757400000000000000000000000000000000000000000000000000000000000060648201526084016102cf565b50505050565b5f80808061037585870187611aed565b604051630b4c774160e11b81526001600160a01b03808616600483018190528186166024840181905262ffffff85166044850152969a5094985092965090945092909110915f917f00000000000000000000000000000000000000000000000000000000000000001690631698ee8290606401602060405180830381865afa158015610403573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906104279190611b3d565b9050336001600160a01b03821614801561044957506001600160a01b03811615155b6104bb5760405162461bcd60e51b815260206004820152602f60248201527f50616e63616b6556335377617043616c6c6261636b3a204d73672e73656e646560448201527f72206973206e6f74206120706f6f6c000000000000000000000000000000000060648201526084016102cf565b5f826104c757896104c9565b8a5b90508481146105405760405162461bcd60e51b815260206004820152602e60248201527f50616e63616b6556335377617043616c6c6261636b3a20616d6f756e74546f5060448201527f617920213d20616d6f756e74496e00000000000000000000000000000000000060648201526084016102cf565b61054b878383610c93565b5050505050505050505050565b6060336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146105f85760405162461bcd60e51b815260206004820152603460248201527f556e697377617056345377617043616c6c6261636b3a204d73672e73656e646560448201527f72206973206e6f7420506f6f6c4d616e6167657200000000000000000000000060648201526084016102cf565b5f61060583850185611c83565b90505f5f61061283610ce6565b845191935091507f0000000000000000000000000000000000000000000000000000000000000000906001600160a01b03166106b157806001600160a01b03166311da60b4836040518263ffffffff1660e01b815260040160206040518083038185885af1158015610686573d5f5f3e3d5ffd5b50505050506040513d601f19601f820116820180604052508101906106ab9190611d73565b50610741565b83516106de907f000000000000000000000000000000000000000000000000000000000000000084610c93565b806001600160a01b03166311da60b46040518163ffffffff1660e01b81526004016020604051808303815f875af115801561071b573d5f5f3e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061073f9190611d73565b505b60208401516101008501516040517f0b0d9c090000000000000000000000000000000000000000000000000000000081526001600160a01b03928316600482015290821660248201526044810185905290821690630b0d9c09906064015f604051808303815f87803b1580156107b5575f5ffd5b505af11580156107c7573d5f5f3e3d5ffd5b5050505060405180602001604052805f8152509450505050505b92915050565b5f8080806107f785870187611aed565b604051630b4c774160e11b81526001600160a01b03808616600483018190528186166024840181905262ffffff85166044850152969a5094985092965090945092909110915f917f00000000000000000000000000000000000000000000000000000000000000001690631698ee8290606401602060405180830381865afa158015610885573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906108a99190611b3d565b9050336001600160a01b0382161480156108cb57506001600160a01b03811615155b61093d5760405162461bcd60e51b815260206004820152602f60248201527f556e697377617056335377617043616c6c6261636b3a204d73672e73656e646560448201527f72206973206e6f74206120706f6f6c000000000000000000000000000000000060648201526084016102cf565b5f82610949578961094b565b8a5b90508481146105405760405162461bcd60e51b815260206004820152602e60248201527f556e697377617056335377617043616c6c6261636b3a20616d6f756e74546f5060448201527f617920213d20616d6f756e74496e00000000000000000000000000000000000060648201526084016102cf565b5f816014526f70a082310000000000000000000000005f5260208060246010865afa601f3d111660205102905092915050565b338031905f90610a26907f0000000000000000000000000000000000000000000000000000000000000000906109c2565b90505f5b85811015610c8a575f878783818110610a4557610a45611d8a565b9050013560f81c60f81b90505f868684818110610a6457610a64611d8a565b9050602002810190610a769190611a22565b8080601f0160208091040260200160405190810160405280939291908181526020018383808284375f9201829052509394505050600160f81b6001600160f81b031985161080159150610af357507f06000000000000000000000000000000000000000000000000000000000000006001600160f81b0319841611155b905080610b425760405162461bcd60e51b815260206004820152600f60248201527f496e76616c696420636f6d6d616e64000000000000000000000000000000000060448201526064016102cf565b6001600160f81b03198316600160f81b1480610b8757506001600160f81b031983167f0200000000000000000000000000000000000000000000000000000000000000145b15610b9557610b958261104d565b7ffd000000000000000000000000000000000000000000000000000000000000006001600160f81b0319841601610bcf57610bcf826110f1565b7ffc000000000000000000000000000000000000000000000000000000000000006001600160f81b0319841601610c0a57610c0a8287611198565b7ffb000000000000000000000000000000000000000000000000000000000000006001600160f81b0319841601610c4557610c458286611287565b7ffa000000000000000000000000000000000000000000000000000000000000006001600160f81b0319841601610c7f57610c7f826113bf565b505050600101610a2a565b50505050505050565b81601452806034526fa9059cbb0000000000000000000000005f5260205f604460105f875af18060015f511416610cdc57803d853b151710610cdc576390b8ec185f526004601cfd5b505f603452505050565b5f5f5f5f610cfb855f01518660200151611444565b915091505f6040518060a00160405280846001600160a01b03168152602001836001600160a01b03168152602001876060015162ffffff168152602001876080015160020b81526020018760c001516001600160a01b031681525090505f8660a00151610d7c5773fffd8963efd1fc6a506488495d951d5263988d25610d83565b6401000276ad5b90505f60405180606001604052808960a00151151581526020018960400151610dab90611d9e565b8152602001836001600160a01b031681525090505f7f000000000000000000000000000000000000000000000000000000000000000090505f816001600160a01b031663f3cd914c86858d60e001516040518463ffffffff1660e01b8152600401610e1893929190611dd4565b6020604051808303815f875af1158015610e34573d5f5f3e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610e589190611d73565b8a516040517fa58411940000000000000000000000000000000000000000000000000000000081526001600160a01b03918216600482015291925083169063a5841194906024015f604051808303815f87803b158015610eb6575f5ffd5b505af1158015610ec8573d5f5f3e3d5ffd5b505050505f8a60a00151610ee557610ee082600f0b90565b610eef565b610eef8260801d90565b90505f81600f0b12610f435760405162461bcd60e51b815260206004820152601860248201527f56343a20506f73697469766520696e7075742064656c7461000000000000000060448201526064016102cf565b610f4c81611e6a565b6fffffffffffffffffffffffffffffffff1698508a604001518914610fb35760405162461bcd60e51b815260206004820152601b60248201527f56343a20616d6f756e74546f50617920213d20616d6f756e74496e000000000060448201526064016102cf565b5f8b60a00151610fcc57610fc78360801d90565b610fd6565b610fd683600f0b90565b90505f81600f0b1361102a5760405162461bcd60e51b815260206004820152601960248201527f56343a204e65676174697665206f75747075742064656c74610000000000000060448201526064016102cf565b806fffffffffffffffffffffffffffffffff169a50505050505050505050915091565b5f818060200190518101906110629190611eb1565b60808101519091506001600160f81b0319165f036110875761108381611477565b5050565b60808101516001600160f81b031916600160f81b036110a95761108381611610565b60405162461bcd60e51b815260206004820152601460248201527f496e76616c696420706f6f6c2076617269616e7400000000000000000000000060448201526064016102cf565b6040517f48c894910000000000000000000000000000000000000000000000000000000081526001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016906348c89491906111569084906004016119ce565b5f604051808303815f875af1158015611171573d5f5f3e3d5ffd5b505050506040513d5f823e601f3d908101601f191682016040526110839190810190611f3f565b5f828060200190518101906111ad9190611ff4565b905033315f6111bc8483611abf565b83519091508110156112105760405162461bcd60e51b815260206004820152601f60248201527f536c697070616765436865636b3a20496e73756666696369656e74204554480060448201526064016102cf565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031663d0e30db0826040518263ffffffff1660e01b81526004015f604051808303818588803b158015611269575f5ffd5b505af115801561127b573d5f5f3e3d5ffd5b50505050505050505050565b5f8280602001905181019061129c9190611ff4565b90505f6112c97f0000000000000000000000000000000000000000000000000000000000000000336109c2565b90505f6112d68483611abf565b835190915081101561132a5760405162461bcd60e51b815260206004820181905260248201527f536c697070616765436865636b3a20496e73756666696369656e74205745544860448201526064016102cf565b6040517f2e1a7d4d000000000000000000000000000000000000000000000000000000008152600481018290527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031690632e1a7d4d906024015f604051808303815f87803b1580156113a2575f5ffd5b505af11580156113b4573d5f5f3e3d5ffd5b505050505050505050565b5f818060200190518101906113d49190611ff4565b90507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031663d0e30db0825f01516040518263ffffffff1660e01b81526004015f604051808303818588803b158015611432575f5ffd5b505af1158015610c8a573d5f5f3e3d5ffd5b5f5f826001600160a01b0316846001600160a01b0316101561146a575082905081611470565b50819050825b9250929050565b5f5f61148f83602001518460600151855f0151610c93565b5f5f84606001516001600160a01b0316630902f1ac6040518163ffffffff1660e01b8152600401606060405180830381865afa1580156114d1573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906114f5919061202b565b506dffffffffffffffffffffffffffff1691506dffffffffffffffffffffffffffff16915084604001516001600160a01b031685602001516001600160a01b031610156115475781935080925061154e565b8093508192505b50505f611569845f015184848760a0015162ffffff1661172f565b90505f5f85604001516001600160a01b031686602001516001600160a01b03161061159557825f611598565b5f835b6060880151604080515f815260208101918290527f022c0d9f000000000000000000000000000000000000000000000000000000009091529294509092506001600160a01b03169063022c0d9f906115f99085908590339060248101612077565b5f604051808303815f87803b158015611269575f5ffd5b604081015160208201516001600160a01b039182169116105f816116485773fffd8963efd1fc6a506488495d951d5263988d2561164f565b6401000276ad5b905082606001516001600160a01b031663128acb083384865f015185886020015189604001518a5f01518b60a001516040516020016116ba94939291906001600160a01b039485168152929093166020830152604082015262ffffff91909116606082015260800190565b6040516020818303038152906040526040518663ffffffff1660e01b81526004016116e99594939291906120ae565b60408051808303815f875af1158015611704573d5f5f3e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061172891906120f7565b5050505050565b5f5f85116117a55760405162461bcd60e51b815260206004820152602b60248201527f556e697377617056324c6962726172793a20494e53554646494349454e545f4960448201527f4e5055545f414d4f554e5400000000000000000000000000000000000000000060648201526084016102cf565b5f841180156117b357505f83115b6118255760405162461bcd60e51b815260206004820152602860248201527f556e697377617056324c6962726172793a20494e53554646494349454e545f4c60448201527f495155494449545900000000000000000000000000000000000000000000000060648201526084016102cf565b5f600a611833606485612119565b61183f90612710611abf565b6118499190612119565b90505f6118568288612138565b90505f6118638683612138565b90505f82611873896103e8612138565b61187d919061214f565b90506118898183612119565b9998505050505050505050565b5f602082840312156118a6575f5ffd5b813567ffffffffffffffff8111156118bc575f5ffd5b8201608081850312156118cd575f5ffd5b9392505050565b5f5f83601f8401126118e4575f5ffd5b50813567ffffffffffffffff8111156118fb575f5ffd5b602083019150836020828501011115611470575f5ffd5b5f5f5f5f60608587031215611925575f5ffd5b8435935060208501359250604085013567ffffffffffffffff811115611949575f5ffd5b611955878288016118d4565b95989497509550505050565b5f5f60208385031215611972575f5ffd5b823567ffffffffffffffff811115611988575f5ffd5b611994858286016118d4565b90969095509350505050565b5f81518084528060208401602086015e5f602082860101526020601f19601f83011685010191505092915050565b602081525f6118cd60208301846119a0565b6001600160a01b03811681146119f4575f5ffd5b50565b8035611a02816119e0565b919050565b5f60208284031215611a17575f5ffd5b81356118cd816119e0565b5f5f8335601e19843603018112611a37575f5ffd5b83018035915067ffffffffffffffff821115611a51575f5ffd5b602001915036819003821315611470575f5ffd5b5f5f8335601e19843603018112611a7a575f5ffd5b83018035915067ffffffffffffffff821115611a94575f5ffd5b6020019150600581901b3603821315611470575f5ffd5b634e487b7160e01b5f52601160045260245ffd5b818103818111156107e1576107e1611aab565b62ffffff811681146119f4575f5ffd5b8035611a0281611ad2565b5f5f5f5f60808587031215611b00575f5ffd5b8435611b0b816119e0565b93506020850135611b1b816119e0565b9250604085013591506060850135611b3281611ad2565b939692955090935050565b5f60208284031215611b4d575f5ffd5b81516118cd816119e0565b634e487b7160e01b5f52604160045260245ffd5b604051610120810167ffffffffffffffff81118282101715611b9057611b90611b58565b60405290565b60405160c0810167ffffffffffffffff81118282101715611b9057611b90611b58565b604051601f8201601f1916810167ffffffffffffffff81118282101715611be257611be2611b58565b604052919050565b8035600281900b8114611a02575f5ffd5b80358015158114611a02575f5ffd5b5f67ffffffffffffffff821115611c2357611c23611b58565b50601f01601f191660200190565b5f82601f830112611c40575f5ffd5b8135611c53611c4e82611c0a565b611bb9565b818152846020838601011115611c67575f5ffd5b816020850160208301375f918101602001919091529392505050565b5f60208284031215611c93575f5ffd5b813567ffffffffffffffff811115611ca9575f5ffd5b82016101208185031215611cbb575f5ffd5b611cc3611b6c565b611ccc826119f7565b8152611cda602083016119f7565b602082015260408281013590820152611cf560608301611ae2565b6060820152611d0660808301611bea565b6080820152611d1760a08301611bfb565b60a0820152611d2860c083016119f7565b60c082015260e082013567ffffffffffffffff811115611d46575f5ffd5b611d5286828501611c31565b60e083015250611d6561010083016119f7565b610100820152949350505050565b5f60208284031215611d83575f5ffd5b5051919050565b634e487b7160e01b5f52603260045260245ffd5b5f7f80000000000000000000000000000000000000000000000000000000000000008203611dce57611dce611aab565b505f0390565b6001600160a01b0384511681526001600160a01b03602085015116602082015262ffffff6040850151166040820152606084015160020b60608201526001600160a01b0360808501511660808201528251151560a0820152602083015160c08201526001600160a01b0360408401511660e08201526101206101008201525f611e616101208301846119a0565b95945050505050565b5f81600f0b7fffffffffffffffffffffffffffffffff800000000000000000000000000000008103611e9e57611e9e611aab565b5f0392915050565b8051611a0281611ad2565b5f60c0828403128015611ec2575f5ffd5b50611ecb611b96565b825181526020830151611edd816119e0565b60208201526040830151611ef0816119e0565b60408201526060830151611f03816119e0565b606082015260808301516001600160f81b031981168114611f22575f5ffd5b6080820152611f3360a08401611ea6565b60a08201529392505050565b5f60208284031215611f4f575f5ffd5b815167ffffffffffffffff811115611f65575f5ffd5b8201601f81018413611f75575f5ffd5b8051611f83611c4e82611c0a565b818152856020838501011115611f97575f5ffd5b8160208401602083015e5f91810160200191909152949350505050565b5f60208284031215611fc4575f5ffd5b6040516020810167ffffffffffffffff81118282101715611fe757611fe7611b58565b6040529151825250919050565b5f60208284031215612004575f5ffd5b6118cd8383611fb4565b80516dffffffffffffffffffffffffffff81168114611a02575f5ffd5b5f5f5f6060848603121561203d575f5ffd5b6120468461200e565b92506120546020850161200e565b9150604084015163ffffffff8116811461206c575f5ffd5b809150509250925092565b8481528360208201526001600160a01b0383166040820152608060608201525f6120a460808301846119a0565b9695505050505050565b6001600160a01b038616815284151560208201528360408201526001600160a01b038316606082015260a060808201525f6120ec60a08301846119a0565b979650505050505050565b5f5f60408385031215612108575f5ffd5b505080516020909101519092909150565b5f8261213357634e487b7160e01b5f52601260045260245ffd5b500490565b80820281158282048414176107e1576107e1611aab565b808201808211156107e1576107e1611aab56fea26469706673582212200d78751fde9979828e486706ac0261dec8947813876d7bcc30e92b207fd50aa564736f6c634300081e0033";

   #[tokio::test(flavor = "multi_thread", worker_threads = 1)]
   async fn v2_swap_erc20_to_erc20_mainnet() {
      let chain_id = 1;

      let pool: AnyUniswapPool = UniswapV2Pool::weth_uni().into();
      let currency_in = Currency::from(ERC20Token::weth());
      let currency_out = pool.quote_currency().clone();
      let amount_in = NumericValue::parse_to_wei("10", currency_in.decimals());

      let swap_on_v2 = true;
      let swap_on_v3 = true;
      let swap_on_v4 = true;
      let max_hops = 2;
      let max_routes = 1;
      let with_split_routing = true;

      test_swap_eip7702(
         chain_id,
         amount_in,
         currency_in,
         currency_out,
         swap_on_v2,
         swap_on_v3,
         swap_on_v4,
         max_hops,
         max_routes,
         with_split_routing,
         vec![pool],
      )
      .await
      .unwrap();
   }

   #[tokio::test(flavor = "multi_thread", worker_threads = 1)]
   async fn v4_single_swap_mainnet() {
      let chain_id = 1;

      let currency_in = Currency::from(NativeCurrency::from(chain_id));
      let currency_out = Currency::from(ERC20Token::usdt());
      let amount_in = NumericValue::parse_to_wei("1", currency_in.decimals());

      let swap_on_v2 = false;
      let swap_on_v3 = false;
      let swap_on_v4 = true;
      let max_hops = 2;
      let max_routes = 1;
      let with_split_routing = false;

      test_swap_eip7702(
         chain_id,
         amount_in,
         currency_in,
         currency_out,
         swap_on_v2,
         swap_on_v3,
         swap_on_v4,
         max_hops,
         max_routes,
         with_split_routing,
         vec![],
      )
      .await
      .unwrap();
   }

   #[tokio::test(flavor = "multi_thread", worker_threads = 1)]
   async fn big_swap_from_usdt_to_eth_mainnet() {
      let chain_id = 1;

      let currency_in = Currency::from(ERC20Token::usdt());
      let currency_out = Currency::from(NativeCurrency::from(chain_id));
      let amount_in = NumericValue::parse_to_wei("1000000", currency_in.decimals());

      let swap_on_v2 = true;
      let swap_on_v3 = true;
      let swap_on_v4 = true;
      let max_hops = 10;
      let max_routes = 10;
      let with_split_routing = true;

      test_swap_eip7702(
         chain_id,
         amount_in,
         currency_in,
         currency_out,
         swap_on_v2,
         swap_on_v3,
         swap_on_v4,
         max_hops,
         max_routes,
         with_split_routing,
         vec![],
      )
      .await
      .unwrap();
   }

   #[tokio::test(flavor = "multi_thread", worker_threads = 1)]
   async fn big_swap_from_usdt_to_weth_mainnet() {
      let chain_id = 1;

      let currency_in = Currency::from(ERC20Token::usdt());
      let currency_out = Currency::from(ERC20Token::weth());
      let amount_in = NumericValue::parse_to_wei("1000000", currency_in.decimals());

      let swap_on_v2 = true;
      let swap_on_v3 = true;
      let swap_on_v4 = true;
      let max_hops = 10;
      let max_routes = 10;
      let with_split_routing = true;

      test_swap_eip7702(
         chain_id,
         amount_in,
         currency_in,
         currency_out,
         swap_on_v2,
         swap_on_v3,
         swap_on_v4,
         max_hops,
         max_routes,
         with_split_routing,
         vec![],
      )
      .await
      .unwrap();
   }

   async fn test_swap_eip7702(
      chain: u64,
      amount_in: NumericValue,
      currency_in: Currency,
      currency_out: Currency,
      swap_on_v2: bool,
      swap_on_v3: bool,
      swap_on_v4: bool,
      max_hops: usize,
      max_routes: usize,
      with_split_routing: bool,
      given_pools: Vec<AnyUniswapPool>,
   ) -> Result<(), anyhow::Error> {
      let ctx = ZeusCtx::new();
      ctx.write(|ctx| ctx.providers.all_working());

      let pools = if given_pools.is_empty() {
         let relevant_pools = get_relevant_pools(
            ctx.clone(),
            swap_on_v2,
            swap_on_v3,
            swap_on_v4,
            &currency_in,
            &currency_out,
         );
         relevant_pools
      } else {
         given_pools
      };

      let pool_manager = ctx.pool_manager();
      let updated_pools = pool_manager.update_state_for_pools(ctx.clone(), chain, pools).await?;

      let eth = Currency::from(NativeCurrency::from(chain));
      let eth_price = ctx.get_currency_price(&eth);
      let currency_out_price = ctx.get_currency_price(&currency_out);
      let base_fee = BaseFee::default();
      let priority_fee = NumericValue::parse_to_gwei("1");

      let quote = if with_split_routing {
         get_quote_with_split_routing(
            amount_in.clone(),
            currency_in.clone(),
            currency_out.clone(),
            updated_pools,
            eth_price.clone(),
            currency_out_price.clone(),
            base_fee.next,
            priority_fee.wei(),
            max_hops,
            max_routes,
         )
      } else {
         get_quote(
            amount_in.clone(),
            currency_in.clone(),
            currency_out.clone(),
            updated_pools,
            eth_price.clone(),
            currency_out_price.clone(),
            base_fee.next,
            priority_fee.wei(),
            max_hops,
         )
      };

      let slippage = 0.5;
      let swap_steps = quote.swap_steps;
      let amount_out = quote.amount_out;
      let min_amount_out = amount_out.calc_slippage(slippage, currency_out.decimals());

      eprintln!(
         "Quote {} {} For {} {}",
         amount_in.format_abbreviated(),
         currency_in.symbol(),
         currency_out.symbol(),
         amount_out.format_abbreviated()
      );
      eprintln!("Swap Steps Length: {}", swap_steps.len());

      for swap in &swap_steps {
         eprintln!(
            "Swap Step: {} (Wei: {}) {} -> {} (Wei: {}) {} {} ({})",
            swap.amount_in.format_abbreviated(),
            swap.amount_in.wei(),
            swap.currency_in.symbol(),
            swap.amount_out.format_abbreviated(),
            swap.amount_out.wei(),
            swap.currency_out.symbol(),
            swap.pool.dex_kind().as_str(),
            swap.pool.fee().fee()
         );
      }

      let client = ctx.get_client(chain).await?;

      let eth_balance = if currency_in.is_native() {
         amount_in.wei()
      } else {
         U256::ZERO
      };

      eprintln!("Alice ETH Balance: {}", eth_balance);
      let alice = DummyAccount::new(AccountType::EOA, eth_balance);
      let _signer = SecureSigner::from(alice.key.clone());

      let block = client.get_block(BlockId::latest()).await.unwrap();
      let mut factory = ForkFactory::new_sandbox_factory(client.clone(), chain, None, None);
      factory.insert_dummy_account(alice.clone());

      if currency_in.is_erc20() {
         factory.give_token(
            alice.address,
            currency_in.address(),
            amount_in.wei(),
         )?;
      }

      let fork_db = factory.new_sandbox_fork();
      let mut evm = new_evm(chain.into(), block.as_ref(), fork_db);
      evm.cfg.disable_nonce_check = false;

      let delegate_addr = deploy_zeus_delegator(&mut evm, alice.address, 0, chain)?;

      let swap_params = encode_swap_delegate(
         chain,
         swap_steps,
         amount_in.wei(),
         min_amount_out.wei(),
         slippage,
         currency_in.clone(),
         currency_out.clone(),
         alice.address,
      )
      .await?;

      let authorization = Authorization {
         chain_id: U256::from(chain),
         address: delegate_addr,
         nonce: 2,
      };

      let signature = alice.key.sign_hash_sync(&authorization.signature_hash())?;
      let signed_authorization = authorization.into_signed(signature);

      let router_balance = evm.balance(delegate_addr).unwrap().data;
      let balance = NumericValue::format_wei(router_balance, 18);
      eprintln!(
         "Delegate contract ETH Balance Before: {}",
         balance.format_abbreviated()
      );

      evm.tx.caller = alice.address;
      evm.tx.data = swap_params.call_data.clone();
      evm.tx.authorization_list = vec![Either::Left(signed_authorization)];
      evm.tx.value = swap_params.value.clone();
      evm.tx.kind = TxKind::Call(alice.address);
      evm.tx.nonce = 1;
      evm.tx.chain_id = Some(chain);
      evm.tx.tx_type = 4;

      let res = evm.transact_commit(evm.tx.clone()).unwrap();
      let output = res.output().unwrap();
      if !res.is_success() {
         let err = revert_msg(&output);
         eprintln!("Call Reverted: {}", err);
         eprintln!("Output: {:?}", output);
         eprintln!("Gas Used: {}", res.gas_used());
         panic!("Delegate Call Failed");
      }

      eprintln!("Delegate Call Successful");
      eprintln!("Gas Used: {}", res.gas_used());

      evm.cfg.disable_nonce_check = true;

      let delegate_balance = evm.balance(delegate_addr).unwrap().data;
      let balance = NumericValue::format_wei(delegate_balance, 18);
      eprintln!(
         "Delegate contract ETH Balance After: {}",
         balance.format_abbreviated()
      );

      let currency_out_balance = if currency_out.is_erc20() {
         simulate::erc20_balance(&mut evm, currency_out.address(), alice.address).unwrap()
      } else {
         let state = evm.balance(alice.address).unwrap();
         state.data
      };

      if currency_out_balance < min_amount_out.wei() {
         panic!(
            "TooLittleReceived, expected {} got {}",
            min_amount_out.wei(),
            currency_out_balance
         );
      }

      let balance = NumericValue::format_wei(currency_out_balance, currency_out.decimals());

      eprintln!(
         "{} Quote Amount: {}",
         currency_out.symbol(),
         amount_out.format_abbreviated()
      );

      eprintln!(
         "{} Got from Swap: {}",
         currency_out.symbol(),
         balance.format_abbreviated()
      );

      Ok(())
   }

   fn deploy_zeus_delegator(
      evm: &mut Evm2<ForkDB>,
      caller: Address,
      nonce: u64,
      chain: u64,
   ) -> Result<Address, anyhow::Error> {
      let weth = address_book::weth(chain)?;
      let v4_pool_manager = address_book::uniswap_v4_pool_manager(chain)?;
      let uni_v3_factory = address_book::uniswap_v3_factory(chain)?;
      let pancake_v3_factory = address_book::pancakeswap_v3_factory(chain)?;

      let deploy_params = zeus_abi::ZeusDelegate::DeployParams {
         weth,
         v4PoolManager: v4_pool_manager,
         uniswapV3Factory: uni_v3_factory,
         pancakeSwapV3Factory: pancake_v3_factory,
      }
      .abi_encode();

      let code = Bytes::from_str(ZEUS_DELEGATE_CODE)?;
      let bytecode = [code.as_ref(), &deploy_params].concat();

      evm.tx.caller = caller;
      evm.tx.data = bytecode.into();
      evm.tx.kind = TxKind::Create;
      evm.tx.value = U256::ZERO;
      evm.tx.nonce = nonce;

      let res = evm.transact_commit(evm.tx.clone())?;
      eprintln!("Gas Used for Deploy: {}", res.gas_used());

      let address = match res {
         ExecutionResult::Success { output, .. } => output.address().cloned(),
         _ => None,
      };

      Ok(address.unwrap())
   }

   #[tokio::test(flavor = "multi_thread", worker_threads = 1)]
   async fn test_deploy_delegator() {
      let ctx = ZeusCtx::new();
      ctx.write(|ctx| ctx.providers.all_working());

      let chain = 1;

      let client = ctx.get_client(chain).await.unwrap();
      let block = client.get_block(BlockId::latest()).await.unwrap().unwrap();
      let fork_factory = ForkFactory::new_sandbox_factory(client.clone(), chain, None, None);
      let fork_db = fork_factory.new_sandbox_fork();
      let mut evm = new_evm(chain.into(), Some(&block), fork_db);

      let weth = address_book::weth(chain).unwrap();
      let v4_pool_manager = address_book::uniswap_v4_pool_manager(chain).unwrap();
      let uni_v3_factory = address_book::uniswap_v3_factory(chain).unwrap();
      let pancake_v3_factory = address_book::pancakeswap_v3_factory(chain).unwrap();

      let deploy_params = zeus_abi::ZeusDelegate::DeployParams {
         weth,
         v4PoolManager: v4_pool_manager,
         uniswapV3Factory: uni_v3_factory,
         pancakeSwapV3Factory: pancake_v3_factory,
      }
      .abi_encode();

      let code = Bytes::from_str(ZEUS_DELEGATE_CODE).unwrap();
      let bytecode = [code.as_ref(), &deploy_params].concat();

      let alice = DummyAccount::new(AccountType::EOA, U256::ZERO);

      evm.tx.caller = alice.address;
      evm.tx.data = bytecode.into();
      evm.tx.kind = TxKind::Create;
      evm.tx.value = U256::ZERO;

      let res = evm.transact_commit(evm.tx.clone()).unwrap();
      eprintln!("Gas Used for Deploy: {}", res.gas_used());

      let address = match res {
         ExecutionResult::Success { output, .. } => output.address().cloned().unwrap(),
         _ => panic!("Failed to deploy router"),
      };

      eprintln!("Router Deployed At Address: {}", address);

      evm.tx.data = zeus_abi::ZeusDelegate::WETHCall {}.abi_encode().into();
      evm.tx.kind = TxKind::Call(address);

      let res = evm.transact_commit(evm.tx.clone()).unwrap();
      let output = res.output().unwrap();
      let weth_address =
         zeus_abi::ZeusDelegate::WETHCall::abi_decode_returns(output.as_ref()).unwrap();
      assert_eq!(weth_address, weth);

      evm.tx.data = zeus_abi::ZeusDelegate::V4_POOL_MANAGERCall {}.abi_encode().into();
      evm.tx.kind = TxKind::Call(address);

      let res = evm.transact_commit(evm.tx.clone()).unwrap();
      let output = res.output().unwrap();
      let v4_pool_manager_address =
         zeus_abi::ZeusDelegate::V4_POOL_MANAGERCall::abi_decode_returns(output.as_ref()).unwrap();
      assert_eq!(v4_pool_manager_address, v4_pool_manager);

      evm.tx.data = zeus_abi::ZeusDelegate::UNISWAP_V3_FACTORYCall {}.abi_encode().into();
      evm.tx.kind = TxKind::Call(address);

      let res = evm.transact_commit(evm.tx.clone()).unwrap();
      let output = res.output().unwrap();
      let uni_v3_factory_address =
         zeus_abi::ZeusDelegate::UNISWAP_V3_FACTORYCall::abi_decode_returns(output.as_ref())
            .unwrap();
      assert_eq!(uni_v3_factory_address, uni_v3_factory);

      evm.tx.data = zeus_abi::ZeusDelegate::PANCAKE_SWAP_V3_FACTORYCall {}.abi_encode().into();
      evm.tx.kind = TxKind::Call(address);

      let res = evm.transact_commit(evm.tx.clone()).unwrap();
      let output = res.output().unwrap();
      let pancake_v3_factory_address =
         zeus_abi::ZeusDelegate::PANCAKE_SWAP_V3_FACTORYCall::abi_decode_returns(output.as_ref())
            .unwrap();
      assert_eq!(pancake_v3_factory_address, pancake_v3_factory);
   }
}
